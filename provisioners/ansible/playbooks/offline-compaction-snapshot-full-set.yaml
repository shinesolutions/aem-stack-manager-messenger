---
- name: SNS Message Sender
  hosts: all
  gather_facts: no
  connection: local

  vars:
    subject: "{{target_aem_stack_prefix}} - offline-compaction-snapshot-full-set"

  tasks:
    - name: "Get facts for Target AEM Stack {{ target_aem_stack_prefix }}"
      ec2_instance_facts:
        filters:
          "tag:StackPrefix": "{{ target_aem_stack_prefix }}"
        region: "{{ aws.region }}"
      # To reduce the output of the playbook this outputs is suppress.
      # The value can be replaced with a debug true/false option in the future.
      no_log: False
      register: target_aem_stack_exists

    - name: "Check if Target AEM Stack {{ target_aem_stack_prefix }} exist."
      fail:
        msg: "Error: Target AEM Stack '{{ target_aem_stack_prefix }}' does not exists."
      when: target_aem_stack_exists.instances is defined and target_aem_stack_exists.instances[0] is undefined

    - set_fact:
        main_stack_name: "{{ stack_prefix }}-{{ main.stack_name }}"

    - name: "Retrieve Main Stack CloudFormation resources facts"
      cloudformation_facts:
        stack_name: "{{ main_stack_name }}"
        region: "{{ aws.region }}"
      register: main_stack_facts

    - set_fact:
        stack_manager_stack_arn: "{{ main_stack_facts.ansible_facts.cloudformation[main_stack_name].stack_outputs.StackManagerStackArn }}"

    - set_fact:
        stack_manager_stack_name: "{{ stack_manager_stack_arn.split('/')[1] }}"

    - name: "Retrieve Stack Manager CloudFormation resources facts"
      cloudformation_facts:
        stack_name: "{{ stack_manager_stack_name }}"
        region: "{{ aws.region }}"
      register: stack_manager_stack_facts

    - set_fact:
        stack_manager_stack_outputs: "{{ stack_manager_stack_facts.ansible_facts.cloudformation[stack_manager_stack_name].stack_outputs }}"
        s3_bucket: "{{ stack_manager_stack_facts.ansible_facts.cloudformation[stack_manager_stack_name].stack_parameters.DataBucketNameParameter }}"

    - set_fact:
        dynamodb_tablename: "{{ stack_manager_stack_outputs.AemStackManagerTableName }}"
        sns_topic: "{{ stack_manager_stack_outputs.BackupTopicArn }}"

    - debug:
        msg: "Send message: {{ message }}, with subject: {{ subject }}, to topic: {{ sns_topic }}, in region: {{ aws.region }}"

    - name: Query if Backup lock exist
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ target_aem_stack_prefix }}_backup_lock"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_backup_lock

    - name: Check if DB is locked
      set_fact:
        db_backup_locked: "{{dbquery_backup_lock.item[0].command_id.S}}"
      when: dbquery_backup_lock.item[0] is defined

    - name: Fail when DB is locked
      fail:
        msg: "Error: Another offline compaction backup is running"
      when: db_backup_locked is defined

    - name: "Generating message file"
      template:
        src: "../../../templates/sns/offline-compaction-snapshot-full-set.json"
        dest: "../../../stage/offline-compaction-snapshot-full-set.json"
        force: true

    - name: "Load generated message payload file"
      set_fact:
        message: "{{ lookup('file', '../../../stage/offline-compaction-snapshot-full-set.json') }}"

    - name: Send message to SNS Topic
      sns:
        msg: "{{ message }}"
        subject: "{{ subject }}"
        topic: "{{ sns_topic }}"
        region: "{{ aws.region }}"
      register: publish_message

    - name: Scan if Author Standby Service is stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: message_id
        attribute_value: "{{ publish_message.message_id }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_stop_author_standby
      until: cmd_stop_author_standby.item != []
      retries: 720
      delay: 5

    - set_fact:
        cmd_id_stop_author_standby: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_stop_author_standby.item }}"

    - name: Query if Author Standby Service successfully stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_stop_author_standby }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_stop_author_standby

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_stop_author_standby: "{{dbquery_state_stop_author_standby.item[0].state.S}}"
      when: '"item" in dbquery_state_stop_author_standby'

    - name: Check for error when stopping Author Standby Service
      set_fact:
        error_stop_author_standby: 1
        module_error: 1
      when: dbquery_state_failed_stop_author_standby is defined and dbquery_state_failed_stop_author_standby == "Failed"

    - name: Scan if Author Primary Service is stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_stop_author_standby }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_stop_author_primary
      until: cmd_stop_author_primary.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_stop_author_primary: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_stop_author_primary.item }}"
      when: module_error is undefined

    - name: Query if Author Primary Service successfully stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_stop_author_primary }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_stop_author_primary
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_stop_author_primary: "{{dbquery_state_stop_author_primary.item[0].state.S}}"
      when: '"item" in dbquery_state_stop_author_primary'

    - name: Check for error when stopping Author Primary Service
      set_fact:
        error_stop_author_primary: 1
        module_error: 1
      when: dbquery_state_failed_stop_author_primary is defined and dbquery_state_failed_stop_author_primary == "Failed" and module_error is undefined

    - name: Scan if Publish Services are stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_stop_author_primary }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_stop_publish
      until: cmd_stop_publish.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_stop_publish: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_stop_publish.item }}"
      when: module_error is undefined

    - name: Query if Publish Services are successfully stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_stop_publish }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_stop_publish
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_stop_publish: "{{dbquery_state_stop_publish.item[0].state.S}}"
      when: '"item" in dbquery_state_stop_publish'

    - name: Check for error when stopping Publish Service
      set_fact:
        error_stop_publish: 1
        module_error: 1
      when: dbquery_state_failed_stop_publish is defined and dbquery_state_failed_stop_publish == "Failed" and module_error is undefined

    - name: Scan if offline-compaction finished
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_stop_publish }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_offline_compaction
      until: cmd_offline_compaction.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_offline_compaction: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_offline_compaction.item }}"
      when: module_error is undefined

    - name: Query Offline-Compaction was successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_offline_compaction }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_offline_compaction
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_offline_compaction: "{{dbquery_state_offline_compaction.item[0].state.S}}"
      when: '"item" in dbquery_state_offline_compaction'

    - name: Check for error when taking offline compaction
      set_fact:
        error_offline_compaction: 1
        module_error: 1
      when: dbquery_state_failed_offline_compaction is defined and dbquery_state_failed_offline_compaction == "Failed" and module_error is undefined

    - name: Scan if offline-backup is executed
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_offline_compaction }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_offline_backup
      until: cmd_offline_backup.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_offline_backup: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_offline_backup.item }}"
      when: module_error is undefined

    - name: Query Offline-Snapshot was successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_offline_backup }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_offline_snapshot
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_offline_snapshot: "{{dbquery_state_offline_snapshot.item[0].state.S}}"
      when: '"item" in dbquery_state_offline_snapshot'

    - name: Check for error when taking offline backup
      set_fact:
        error_offline_snapshot: 1
        module_error: 1
      when: dbquery_state_failed_offline_snapshot is defined and dbquery_state_failed_offline_snapshot == "Failed" and module_error is undefined

    - name: Scan if Author Primary Service is started
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_offline_backup }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_start_author_primary
      until: cmd_start_author_primary.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_start_author_primary: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_start_author_primary.item }}"
      when: module_error is undefined

    - name: Query if starting Author Primary Service was successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_start_author_primary }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_start_author_primary
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_start_author_primary: "{{dbquery_state_start_author_primary.item[0].state.S}}"
      when: '"item" in dbquery_state_start_author_primary'

    - name: Check for error when starting Author Primary Service
      set_fact:
        error_start_author_primary: 1
        module_error: 1
      when: dbquery_state_failed_start_author_primary is defined and dbquery_state_failed_start_author_primary == "Failed" and module_error is undefined

    - name: Scan if author standby instance is started
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_start_author_primary }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_start_author_standby
      until: cmd_start_author_standby.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_start_author_standby: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_start_author_standby.item }}"
      when: module_error is undefined

    - name: Query if starting Author Standby Service was successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_start_author_standby }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_start_author_standby
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_start_author_standby: "{{dbquery_state_start_author_standby.item[0].state.S}}"
      when: '"item" in dbquery_state_start_author_standby'

    - name: Check for error when starting Author Primary Service
      set_fact:
        error_start_author_standby: 1
        module_error: 1
      when: dbquery_state_failed_start_author_standby is defined and dbquery_state_failed_start_author_standby == "Failed" and module_error is undefined

    - name: Scan if publish instance is started
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_start_author_standby }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_start_publish
      until: cmd_start_publish.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_start_publish: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_start_publish.item }}"
      when: module_error is undefined

    - name: Query if starting Publish Services were successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_start_publish }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_state_start_publish
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_start_publish: "{{dbquery_state_start_publish.item[0].state.S}}"
      when: '"item" in dbquery_state_start_publish'

    - name: Check for error when starting Author Primary Service
      set_fact:
        error_start_publish: 1
        module_error: 1
      when: dbquery_state_failed_start_publish is defined and dbquery_state_failed_start_publish == "Failed" and module_error is undefined

    - name: Scan if job remaining compact jobs are finished
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_start_publish }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_remain_compact_jobs
      until: cmd_remain_compact_jobs.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_remain_compact_jobs: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_remain_compact_jobs.item }}"
      when: module_error is undefined

    - name: Query if remaining compact jobs are finished
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_remain_compact_jobs }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_remain_compact_jobs
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_remain_compact_jobs: "{{dbquery_remain_compact_jobs.item[0].state.S}}"
      when: '"item" in dbquery_remain_compact_jobs'

    - name: Check for error when checking for remaining compact jobs
      set_fact:
        error_remain_compact_jobs: 1
        module_error: 1
      when: dbquery_state_failed_remain_compact_jobs is defined and dbquery_state_failed_remain_compact_jobs == "Failed" and module_error is undefined

    - name: Scan if remaining publish instances are stopped
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_remain_compact_jobs }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_stop_remain_publish
      until: cmd_stop_remain_publish.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_stop_remain_publish: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_stop_remain_publish.item }}"
      when: module_error is undefined

    - name: Query if stopping remaining Publish Services was successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_stop_remain_publish }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_stop_remain_publish
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_stop_remain_publish: "{{dbquery_stop_remain_publish.item[0].state.S}}"
      when: '"item" in dbquery_stop_remain_publish'

    - name: Check for error when checking for remaining compact jobs
      set_fact:
        error_stop_remain_publish: 1
        module_error: 1
      when: dbquery_state_failed_stop_remain_publish is defined and dbquery_state_failed_stop_remain_publish == "Failed" and module_error is undefined

    - name: Scan if remaining publish instances are compacted
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_stop_remain_publish }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_compact_publish
      until: cmd_compact_publish.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_compact_publish: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_compact_publish.item }}"
      when: module_error is undefined

    - name: Query if remaining Publish Instances are compacted successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_compact_publish }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_compact_publish
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_compact_publish: "{{dbquery_compact_publish.item[0].state.S}}"
      when: '"item" in dbquery_compact_publish'

    - name: Check for error when compact remaining Publisher
      set_fact:
        error_remain_compact_publish: 1
        module_error: 1
      when: dbquery_state_failed_compact_publish is defined and dbquery_state_failed_compact_publish == "Failed" and module_error is undefined

    - name: Scan if remaining publish instances are started
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: last_command
        attribute_value: "{{ cmd_id_compact_publish }}"
        get_attribute: command_id
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: scan
        region: "{{ aws.region }}"
      register: cmd_start_remain_publish
      until: cmd_start_remain_publish.item != []
      retries: 720
      delay: 5
      when: module_error is undefined

    - set_fact:
        cmd_id_start_remain_publish: "{{ item.command_id.S }}"
      with_items:
        "{{ cmd_start_remain_publish.item }}"
      when: module_error is undefined

    - name: Query if start remaining remaining Publish Services were successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_start_remain_publish }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery_start_remain_publish
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_state_failed_start_remain_publish: "{{dbquery_start_remain_publish.item[0].state.S}}"
      when: '"item" in dbquery_start_remain_publish'

    - name: Check for error when starting remaining Publisher
      set_fact:
        error_start_remain_publish: 1
        module_error: 1
      when: dbquery_state_failed_start_remain_publish is defined and dbquery_state_failed_start_remain_publish == "Failed" and module_error is undefined

    - name: Query if offline-compaction-snapshot was successful
      dynamodb_search:
        table_name: "{{ dynamodb_tablename }}"
        attribute: command_id
        attribute_value: "{{ cmd_id_start_remain_publish }}"
        get_attribute: state
        select: SPECIFIC_ATTRIBUTES
        comparisonoperator: EQ
        state: query
        region: "{{ aws.region }}"
      register: dbquery
      until: dbquery.item[0].state.S == "Success" or dbquery.item[0].state.S == "Failed"
      retries: 720
      delay: 5
      when: module_error is undefined

    - name: Set fact for error check
      set_fact:
        dbquery_failed: "{{dbquery.item[0].state.S}}"
      when: '"item" in dbquery'

    - name: Check if offline-compaction-snapshot failed
      set_fact:
        general_error: 1
      when: dbquery_failed is defined and dbquery_failed == "Failed" and module_error is undefined

    - name: Get path to output files of stopping Author Standby Service
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_author_standby }}"
      register: output_files_stop_author_standby
      when: cmd_id_stop_author_standby is defined

    - name: Get path to output files of stopping Author Primary Service
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_author_primary }}"
      register: output_files_stop_author_primary
      when: cmd_id_stop_author_primary is defined

    - name: Get path to output files of stopping Publish Service
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_publish }}"
      register: output_files_stop_publish
      when: cmd_id_stop_publish is defined

    - name: Get path to output files of taking offline compaction
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_offline_compaction }}"
      register: output_files_offline_compaction
      when: cmd_id_offline_compaction is defined

    - name: Get path to output files of taking offline backup
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_offline_backup }}"
      register: output_files_offline_backup
      when: cmd_id_offline_backup is defined

    - name: Get path to output files of starting Author Primary Service
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_author_primary }}"
      register: output_files_start_author_primary
      when: cmd_id_start_author_primary is defined

    - name: Get path to output files of starting Author Standby Service
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_author_standby }}"
      register: output_files_start_author_standby
      when: cmd_id_start_author_standby is defined

    - name: Get path to output files of starting Publish Service
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_publish }}"
      register: output_files_start_publish
      when: cmd_id_start_publish is defined

    - name: Get path to output files of checking remaining compaction jobs
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_remain_compact_jobs }}"
      register: output_files_remain_compact_jobs
      when: cmd_id_remain_compact_jobs is defined

    - name: Get path to output files of stopping remaining publisher
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_remain_publish }}"
      register: output_files_stop_remain_publish
      when: cmd_id_stop_remain_publish is defined

    - name: Get path to output files of compact remaining publisher
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_compact_publish }}"
      register: output_files_compact_publish
      when: cmd_id_compact_publish is defined

    - name: Get path to output files of starting remaining publisher
      aws_s3:
        mode: list
        bucket: "{{ s3_bucket }}"
        prefix: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_remain_publish }}"
      register: output_files_start_remain_publish
      when: cmd_id_start_remain_publish is defined

    - name: Set global facts for getting command output
      set_fact:
        log_path: "{{ playbook_dir }}/../../logs/"

    - name: Set facts for getting command output stop Author Standby Service
      set_fact:
        dl_path_stop_author_standby: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_author_standby }}"
        s3_files_stop_author_standby: "{{ output_files_stop_author_standby.s3_keys }}"
      when: error_stop_author_standby is defined or general_error is defined

    - name: Set facts for getting command output stop Author Primary Service
      set_fact:
        dl_path_stop_author_primary: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_author_primary }}"
        s3_files_stop_author_primary: "{{ output_files_stop_author_primary.s3_keys }}"
      when: error_stop_author_primary is defined or general_error is defined

    - name: Set facts for getting command output stop Publish Services
      set_fact:
        dl_path_stop_publish: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_stop_publish }}"
        s3_files_stop_publish: "{{ output_files_stop_publish.s3_keys }}"
      when: error_stop_publish is defined or general_error is defined

    - name: Set facts for getting command output Offline Compaction
      set_fact:
        dl_path_offline_compaction: "{{ stack_prefix }}/stack-manager/SSMOutput/{{cmd_id_offline_compaction}}"
        s3_files_offline_compaction: "{{ output_files_offline_compaction.s3_keys }}"
      when: error_offline_compaction is defined or general_error is defined

    - name: Set facts for getting command output Offline Backup
      set_fact:
        dl_path_offline_backup: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_offline_backup }}"
        s3_files_offline_backup: "{{ output_files_offline_backup.s3_keys }}"
      when: error_offline_snapshot is defined or general_error is defined

    - name: Set facts for getting command output start Author Primary Service
      set_fact:
        dl_path_start_author_primary: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_author_primary }}"
        s3_files_start_author_primary: "{{ output_files_start_author_primary.s3_keys }}"
      when: error_start_author_primary is defined or general_error is defined

    - name: Set facts for getting command output start Author Standby Service
      set_fact:
        dl_path_start_author_standby: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_author_standby }}"
        s3_files_start_author_standby: "{{ output_files_start_author_standby.s3_keys }}"
      when: error_start_author_standby is defined or general_error is defined

    - name: Set facts for getting command output start Publish Services
      set_fact:
        dl_path_start_publish: "{{ stack_prefix }}/stack-manager/SSMOutput/{{ cmd_id_start_publish }}"
        s3_files_start_publish: "{{ output_files_start_publish.s3_keys }}"
      when: error_start_publish is defined or general_error is defined

    - name: Set facts for getting command output remaining compact jobs
      set_fact:
        dl_path_remain_compact_jobs: "{{ stack_prefix }}/stack-manager/SSMOutput/{{cmd_id_remain_compact_jobs}}"
        s3_files_remain_compact_jobs: "{{ output_files_remain_compact_jobs.s3_keys }}"
      when: error_remain_compact_jobs is defined or general_error is defined

    - name: Set facts for getting command output stop remaining Publish Services
      set_fact:
        dl_path_stop_remain_publish: "{{ stack_prefix }}/stack-manager/SSMOutput/{{cmd_id_stop_remain_publish}}"
        s3_files_stop_remain_publish: "{{ output_files_stop_remain_publish.s3_keys }}"
      when: error_stop_remain_publish is defined or general_error is defined

    - name: Set facts for getting command output compact remaining publisher
      set_fact:
        dl_path_compact_publish: "{{ stack_prefix }}/stack-manager/SSMOutput/{{cmd_id_compact_publish}}"
        s3_files_compact_publish: "{{ output_files_compact_publish.s3_keys }}"
      when: error_remain_compact_publish is defined or general_error is defined

    - name: Set facts for getting command output start remaining Publish Servvice
      set_fact:
        dl_path_start_remain_publish: "{{ stack_prefix }}/stack-manager/SSMOutput/{{cmd_id_start_remain_publish}}"
        s3_files_start_remain_publish: "{{ output_files_start_remain_publish.s3_keys }}"
      when: error_start_remain_publish is defined or general_error is defined

    - name: "Create Download directory of stopping Author Standby Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_stop_author_standby }}"
      when: error_stop_author_standby is defined or general_error is defined

    - name: "Create Download directory of stopping Author Primary Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_stop_author_primary }}"
      when: error_stop_author_primary is defined or general_error is defined

    - name: "Create Download directory of stopping Publish Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_stop_publish }}"
      when: error_stop_publish is defined or general_error is defined

    - name: "Create Download directory of taking offline compaction"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_offline_compaction }}"
      when: error_offline_compaction is defined or general_error is defined

    - name: "Create Download directory of taking offline backup Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_offline_backup }}"
      when: error_offline_snapshot is defined or general_error is defined

    - name: "Create Download directory of starting Author Primary Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_start_author_primary }}"
      when: error_start_author_primary is defined or general_error is defined

    - name: "Create Download directory of starting Author Standby Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_start_author_standby }}"
      when: error_start_author_standby is defined or general_error is defined

    - name: "Create Download directory of starting Publish Service"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_start_publish }}"
      when: error_start_publish is defined or general_error is defined

    - name: "Create Download directory of remaining compaction job"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_remain_compact_jobs }}"
      when: error_remain_compact_jobs is defined or general_error is defined

    - name: "Create Download directory of stopping remaining Publisher"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_stop_remain_publish }}"
      when: error_stop_remain_publish is defined or general_error is defined

    - name: "Create Download directory of compact remaining Publisher"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_compact_publish }}"
      when: error_remain_compact_publish is defined or general_error is defined

    - name: "Create Download directory of starting remaining Publisher"
      file:
        path: "{{ log_path }}{{ item|regex_replace('(stdout|stderr)$', '') }}"
        state: directory
      with_items:
        - "{{ s3_files_start_remain_publish }}"
      when: error_start_remain_publish is defined or general_error is defined

    - name: "Save command output stopping Author Standby Service to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_stop_author_standby }}"
      when: error_stop_author_standby is defined or general_error is defined

    - name: "Save command output stopping Author Primary Service to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_stop_author_primary }}"
      when: error_stop_author_primary is defined or general_error is defined

    - name: "Save command output stopping Publish Service to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_stop_publish }}"
      when: error_stop_publish is defined or general_error is defined

    - name: "Save command output taking opffline compaction to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_offline_compaction }}"
      when: error_offline_compaction is defined or general_error is defined

    - name: "Save command output taking offline backup to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_offline_backup }}"
      when: error_offline_snapshot is defined or general_error is defined

    - name: "Save command output starting Author Primary Service to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_start_author_primary }}"
      when: error_start_author_primary is defined or general_error is defined

    - name: "Save command output starting Author Standby Service to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_start_author_standby }}"
      when: error_start_author_standby is defined or general_error is defined

    - name: "Save command output starting Publish Service to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_start_publish }}"
      when: error_start_publish is defined or general_error is defined

    - name: "Save command output check for remaining compaction jobs to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_remain_compact_jobs }}"
      when: error_remain_compact_jobs is defined or general_error is defined

    - name: "Save command output stopping remaining Publisher to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_stop_remain_publish }}"
      when: error_stop_remain_publish is defined or general_error is defined

    - name: "Save command output taking remaining compaction to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_compact_publish }}"
      when: error_remain_compact_publish is defined or general_error is defined

    - name: "Save command output starting remaining Publisher to {{log_path }}"
      aws_s3:
        mode: get
        bucket: "{{ s3_bucket }}"
        object: "{{ item }}"
        dest: "{{ log_path }}{{ item }}"
      with_items:
        - "{{ s3_files_start_remain_publish }}"
      when: error_start_remain_publish is defined or general_error is defined

    - name: "Find error log files of stopping Author Standby Service"
      find:
        paths: "{{log_path }}{{ dl_path_stop_author_standby }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_stop_author_standby
      when: error_stop_author_standby is defined or general_error is defined

    - name: "Find error log files of stopping Author Primary Service"
      find:
        paths: "{{log_path }}{{ dl_path_stop_author_primary }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_stop_author_primary
      when: error_stop_author_primary is defined or general_error is defined

    - name: "Find error log files of stopping Publish Service"
      find:
        paths: "{{log_path }}{{ dl_path_stop_publish }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_stop_publish
      when: error_stop_publish is defined or general_error is defined

    - name: "Find error log files of taking offline compaction"
      find:
        paths: "{{log_path }}{{ dl_path_offline_compaction }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_offline_compaction
      when: error_offline_compaction is defined or general_error is defined

    - name: "Find error log files of taking offline backup"
      find:
        paths: "{{log_path }}{{ dl_path_offline_backup }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_offline_backup
      when: error_offline_snapshot is defined or general_error is defined

    - name: "Find error log files of starting Author Primary Service"
      find:
        paths: "{{log_path }}{{ dl_path_start_author_primary }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_start_author_primary
      when: error_start_author_primary is defined or general_error is defined

    - name: "Find error log files of starting Author Standby Service"
      find:
        paths: "{{log_path }}{{ dl_path_start_author_standby }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_start_author_standby
      when: error_start_author_standby is defined or general_error is defined

    - name: "Find error log files of starting Publish Service"
      find:
        paths: "{{log_path }}{{ dl_path_start_publish }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_path_start_publish
      when: error_start_publish is defined or general_error is defined

    - name: "Find error log files of checking for remaining compaction jobs"
      find:
        paths: "{{log_path }}{{ dl_path_remain_compact_jobs }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_path_remain_compact_jobs
      when: error_remain_compact_jobs is defined or general_error is defined

    - name: "Find error log files of stopping remaining Publisher"
      find:
        paths: "{{log_path }}{{ dl_path_stop_remain_publish }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_path_stop_remain_publish
      when: error_stop_remain_publish is defined or general_error is defined

    - name: "Find error log files of taking remaining offline compaction"
      find:
        paths: "{{log_path }}{{ dl_path_compact_publish }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_path_compact_publish
      when: error_remain_compact_publish is defined or general_error is defined

    - name: "Find error log files of starting remaining Publisher"
      find:
        paths: "{{log_path }}{{ dl_path_start_remain_publish }}"
        file_type: file
        patterns: stderr
        recurse: yes
      register: stderr_path_start_remain_publish
      when: error_start_remain_publish is defined or general_error is defined

    - name: "Show Error Log of stopping Author Standby Service"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_stop_author_standby}}"
      when: error_stop_author_standby is defined or general_error is defined

    - name: "Show Error Log of stopping Author Primary Service"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_stop_author_primary}}"
      when: error_stop_author_primary is defined or general_error is defined

    - name: "Show Error Log of stopping Publish Service"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_stop_publish}}"
      when: error_stop_publish is defined or general_error is defined

    - name: "Show Error Log of taking offline compaction"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_offline_compaction}}"
      when: error_offline_compaction is defined or general_error is defined

    - name: "Show Error Log of taking offline backup"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_offline_backup}}"
      when: error_offline_snapshot is defined or general_error is defined

    - name: "Show Error Log of starting Author Primary Service"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_start_author_primary}}"
      when: error_start_author_primary is defined or general_error is defined

    - name: "Show Error Log of starting Author Standby Service"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_start_author_standby}}"
      when: error_start_author_standby is defined or general_error is defined

    - name: "Show Error Log of starting Publish Service"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_path_start_publish}}"
      when: error_start_publish is defined or general_error is defined

    - name: "Show Error Log of checking remaining compaction jobs"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_path_remain_compact_jobs}}"
      when: error_remain_compact_jobs is defined or general_error is defined

    - name: "Show Error Log of stopping remaining Publisher"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_path_stop_remain_publish}}"
      when: error_stop_remain_publish is defined or general_error is defined

    - name: "Show Error Log of taking remaining offline compaction"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_path_compact_publish}}"
      when: error_remain_compact_publish is defined or general_error is defined

    - name: "Show Error Log of starting remaining Publisher"
      log_output:
        type: file
        log_files: "{{ item.files | map(attribute='path')|list }}"
      with_items:
        - "{{stderr_path_start_remain_publish}}"
      when: error_start_remain_publish is defined or general_error is defined

    - fail:
        msg: "Error: Failed executing event offline-compaction-snapshot-full-set"
      when: general_error is defined or module_error is defined

    - name: Remove generated message payload file
      file:
        path: "../../../stage/offline-snapshot-full-set.json"
        state: absent
